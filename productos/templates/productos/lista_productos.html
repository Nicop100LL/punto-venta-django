{% extends "base.html" %}
{% load custom_filters %}

{% block content %}
<div class="flex min-h-screen bg-gray-100">
  <!-- Contenido principal -->
  <div class="flex-1 p-6">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold">Lista de Productos</h1>
      <div class="flex gap-2">
        <a href="{% url 'exportar_productos_pdf' %}" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
          üìÑ Exportar PDF
        </a>
        <button onclick="openModal()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
          + Agregar Producto
        </button>
      </div>
    </div>

    <!-- Buscador -->
    <div class="mb-4">
      <input type="text" id="buscador" placeholder="Buscar producto..." class="w-full px-3 py-2 border rounded" />
    </div>

    <!-- Productos por categor√≠a -->
    {% for categoria in categorias %}
    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-2">{{ categoria.nombre }}</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for p in productos %}
        {% if p.categoria == categoria %}
        <div class="bg-white p-4 rounded shadow">
          <h3 class="text-lg font-semibold">{{ p.nombre }}</h3>
          <p class="text-sm text-gray-500">C√≥digo: {{ p.codigo }}</p>
          <p>
            Stock:
            {% if p.tipo_venta == "unidad" %}
            {{ p.stock_actual|floatformat:0 }}
            {% else %}
            {{ p.stock_actual|floatformat:2 }}
            {% endif %}
          </p>
          <p>Precio: ${{ p.precio_venta|floatformat:0|formato_precio }}</p>
          <div class="flex justify-between mt-2">
            <a href="{% url 'editar_producto' p.id %}" class="text-blue-600 hover:underline">Editar</a>
            <a href="{% url 'eliminar_producto' p.id %}" class="text-red-600 hover:underline">Eliminar</a>
          </div>
        </div>
        {% endif %}
        {% endfor %}
      </div>
    </div>
    {% empty %}
    <p>No hay productos registrados.</p>
    {% endfor %}
  </div>
</div>

<!-- Modal para agregar producto -->
<div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
  <div class="bg-white p-6 rounded w-full max-w-md" style="max-height: 90%; overflow-y: auto;">
    <h2 class="text-xl font-bold mb-4">Agregar Nuevo Producto</h2>

    <!-- ALERTA CORREGIDA (FUERA DE BOTONES) -->
    <div id="producto-alerta" class="hidden mb-4 px-4 py-2 rounded text-sm"></div>

    <form id="form-nuevo-producto" method="POST" action="{% url 'nuevo_producto' %}">
      {% csrf_token %}
      <div class="mb-2">
        <label class="block">Nombre</label>
        <input type="text" name="nombre" class="w-full border px-3 py-2 rounded" required />
      </div>
      <div class="mb-2">
        <label class="block">C√≥digo</label>
        <input type="text" name="codigo" class="w-full border px-3 py-2 rounded" required />
      </div>
      <div class="mb-2">
        <label class="block">Categor√≠a</label>
        <div class="flex gap-2 items-center">
          <select name="categoria" id="select-categoria" class="flex-1 border px-3 py-2 rounded" required>
            {% for cat in categorias %}
            <option value="{{ cat.id }}">{{ cat.nombre }}</option>
            {% endfor %}
          </select>
          <button type="button" onclick="openCategoriaModal()" title="Agregar categor√≠a"
            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-3 rounded">
            +
          </button>
        </div>
      </div>

      <div class="mb-4">
        <label for="precio_compra" class="block text-sm font-medium text-gray-700">
          Precio de compra
        </label>
        <input type="number" name="precio_compra" id="precio_compra" step="0.01" required
          class="w-full border px-3 py-2 rounded">
      </div>

      <div class="mb-2">
        <label class="block">Precio</label>
        <input type="number" step="0.01" name="precio_venta" class="w-full border px-3 py-2 rounded" required />
      </div>

      <div class="mb-4">
        <label class="block">Tipo de venta</label>
        <select name="tipo_venta" class="w-full border px-3 py-2 rounded" required>
          <option value="unidad">Por unidad</option>
          <option value="kilo">Por kilo</option>
        </select>
      </div>

      <div class="mb-4">
        <label class="block">Stock</label>
        <input type="number" name="stock_actual" step="0.01" class="w-full border px-3 py-2 rounded" required />
      </div>

      <!-- DESCUENTO -->
      <div class="flex items-center gap-2">
        <input type="checkbox" id="aplica_descuento" name="aplica_descuento" value="True"
          class="rounded border-gray-300 text-blue-600 shadow-sm">
        <label for="aplica_descuento" class="text-sm font-medium text-gray-700">Aplicar descuento</label>
      </div>

      <div id="descuento-campos" class="space-y-4 hidden">
        <div>
          <label class="block text-sm font-medium text-gray-700">Cantidad m√≠nima para descuento</label>
          <input type="number" name="cantidad_minima_descuento" min="0" class="w-full border px-3 py-2 rounded">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Porcentaje de descuento</label>
          <input type="number" name="porcentaje_descuento" step="0.01" min="0" max="100" class="w-full border px-3 py-2 rounded">
        </div>
      </div>

      <div class="flex justify-end gap-2 mt-4">
        <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-300 rounded">Cancelar</button>
        <button id="btn-guardar-producto" type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Guardar</button>
      </div>

    </form>
  </div>
</div>

<!-- Modal Categor√≠a -->
<div id="modalCategoria" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
  <div class="bg-white p-6 rounded w-full max-w-sm">
    <h2 class="text-xl font-bold mb-4">Agregar Categor√≠a</h2>

    <div id="categoria-alerta" class="mb-4 hidden px-4 py-2 rounded text-sm"></div>

    <form id="form-nueva-categoria" method="POST" action="{% url 'nueva_categoria' %}">
      {% csrf_token %}
      <div class="mb-4">
        <label class="block">Nombre de la categor√≠a</label>
        <input type="text" id="nombre-categoria" name="nombre" class="w-full border px-3 py-2 rounded" required />
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeCategoriaModal()" class="px-4 py-2 bg-gray-300 rounded">Cancelar</button>
        <button id="btn-guardar-categoria" type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- Toast -->
<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

<!-- Scripts -->
<script>
  function openModal() { document.getElementById('modal').classList.remove('hidden'); }
  function closeModal() { document.getElementById('modal').classList.add('hidden'); }
  function openCategoriaModal() { document.getElementById('modalCategoria').classList.remove('hidden'); }
  function closeCategoriaModal() { document.getElementById('modalCategoria').classList.add('hidden'); }

  document.getElementById('buscador').addEventListener('input', function () {
    const query = this.value.toLowerCase();
    document.querySelectorAll('.bg-white').forEach(p => {
      p.style.display = p.textContent.toLowerCase().includes(query) ? '' : 'none';
    });
  });
</script>

<!-- AJAX Categor√≠as -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('form-nueva-categoria');
    const inputNombre = document.getElementById('nombre-categoria');
    const btnGuardar = document.getElementById('btn-guardar-categoria');

    form.addEventListener('submit', function (e) {
      e.preventDefault();

      btnGuardar.disabled = true;

      fetch("{% url 'nueva_categoria' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: new URLSearchParams({
          nombre: inputNombre.value,
          descripcion: ""   
        })
      })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            closeCategoriaModal();
            const select = document.querySelector('select[name="categoria"]');
            const nuevaOpcion = new Option(data.nombre, data.id, true, true);
            select.add(nuevaOpcion);
            inputNombre.value = '';
            showToast("‚úÖ Categor√≠a agregada exitosamente");
          } else {
            showToast("‚ö†Ô∏è " + data.message, 'error');
          }
        })
        .finally(() => btnGuardar.disabled = false);
    });
  });
</script>

<!-- AJAX Producto -->
<script>
/*
  Script para agregar producto v√≠a AJAX sin recargar la p√°gina
  -----------------------------------------------------------
  - Intercepta el env√≠o del formulario.
  - Env√≠a los datos al backend con X-Requested-With.
  - Si el checkbox de descuento NO est√° marcado, elimina esos campos.
  - Inserta el producto en el DOM (en la categor√≠a correcta) inmediatamente.
  - Muestra toast y cierra el modal.
  - Maneja errores y vuelve a habilitar el bot√≥n de guardar.
*/
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById("form-nuevo-producto");
  const alerta = document.getElementById("producto-alerta");
  const btnGuardar = form.querySelector('button[type="submit"]');

  form.addEventListener("submit", function (e) {
    e.preventDefault();
    btnGuardar.disabled = true;

    const formData = new FormData(form);

    // Si NO aplica descuento, eliminamos esos campos
    if (!document.getElementById("aplica_descuento").checked) {
      formData.delete("cantidad_minima_descuento");
      formData.delete("porcentaje_descuento");
    }

    fetch(form.action, {
      method: "POST",
      headers: {
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
        "X-Requested-With": "XMLHttpRequest"
      },
      body: formData
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          closeModal(); // Cierra el modal
          showToast("‚úÖ Producto agregado correctamente"); // Toast de √©xito

          // Inserta el producto en la categor√≠a correspondiente
          insertarProductoEnCategoria(data.producto);

          // Limpiar formulario y ocultar alerta
          form.reset();
          alerta.classList.add('hidden');
        } else {
          alerta.textContent = data.message || "Error al crear producto";
          alerta.classList.remove("hidden");
          alerta.classList.add("bg-red-100", "text-red-700", "border", "border-red-400");
        }
      })
      .catch(err => {
        console.error("ERROR:", err);
        showToast("‚ùå Error al enviar el formulario", "error");
      })
      .finally(() => btnGuardar.disabled = false);
  });

  /********** FUNCIONES AUXILIARES **********/

  // Inserta una "card" del producto en el grid de su categor√≠a
  function insertarProductoEnCategoria(p) {
    const h2s = Array.from(document.querySelectorAll('h2'));
    const categoriaTitulo = h2s.find(el => el.textContent.trim() === p.categoria);
    if (!categoriaTitulo) return;

    const grid = categoriaTitulo.nextElementSibling;
    if (!grid || !grid.classList.contains('grid')) return;

    const card = document.createElement('div');
    card.className = 'bg-white p-4 rounded shadow producto-card';
    card.innerHTML = `
      <h3 class="text-lg font-semibold">${escapeHtml(p.nombre)}</h3>
      <p class="text-sm text-gray-500">C√≥digo: ${escapeHtml(p.codigo)}</p>
      <p>Stock: ${p.tipo_venta === "unidad" ? Math.round(p.stock_actual) : Number(p.stock_actual).toFixed(2)}</p>
      <p>Precio: $${Number(p.precio_venta)}</p>
      <div class="flex justify-between mt-2">
        <a href="/productos/editar/${p.id}/" class="text-blue-600 hover:underline">Editar</a>
        <a href="/productos/eliminar/${p.id}/" class="text-red-600 hover:underline">Eliminar</a>
      </div>
    `;
    grid.appendChild(card); // appendChild para que aparezca al final
  }

  // Funci√≥n para escapar HTML y evitar inyecci√≥n
  function escapeHtml(text) {
    if (text === null || text === undefined) return "";
    return String(text)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }
});
</script>

<!-- Descuentos -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const check = document.getElementById("aplica_descuento");
    const campos = document.getElementById("descuento-campos");

    function toggle() {
      campos.classList.toggle("hidden", !check.checked);
    }

    check.addEventListener("change", toggle);
    toggle();
  });
</script>

{% endblock %}
