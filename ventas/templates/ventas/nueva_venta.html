{% extends 'base.html' %}

{% load custom_filters %}

{% block title %}Nueva Venta{% endblock %}

{% block content %}
<h2 class="text-xl font-bold mb-4">Nueva Venta</h2>

{% if error %}
<p class="text-red-600 font-semibold mb-2">{{ error }}</p>
{% endif %}

<form method="post" class="mb-6" id="form-agregar">
    {% csrf_token %}
    <div class="mb-4">
        <label for="id_cliente" class="block text-gray-700 font-bold mb-2">Cliente:</label>
        <select name="cliente" id="id_cliente" class="w-full border border-gray-300 rounded px-3 py-2">
            <option value="" {% if not cliente_id %}selected{% endif %}>---------</option>
            {% for cliente in venta_form.fields.cliente.queryset %}
            <option value="{{ cliente.id }}" {% if cliente.id|stringformat:"s" == cliente_id|stringformat:"s" %}
            selected{% endif %}>
                {{ cliente.nombre }}
            </option>
            {% endfor %}
        </select>

        <div id="saldo-cliente" class="mt-2 text-sm text-gray-700">
            {% if saldo_cliente is not None %}
            <p><strong>Saldo actual:</strong> ${{ saldo_cliente|floatformat:2 }}</p>
            {% endif %}
        </div>


        </select>
    </div>
    <div class="mb-4">
        <label for="tipo_pago" class="block text-sm font-medium text-gray-700">Tipo de pago</label>
        <select name="tipo_pago" id="tipo_pago" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm">
            <option value="EF" {% if tipo_pago == 'EF' %}selected{% endif %}>Efectivo</option>
            <option value="MP" {% if tipo_pago == 'MP' %}selected{% endif %}>QR (Mercado Pago)</option>
            <option value="DN" {% if tipo_pago == 'DN' %}selected{% endif %}>QR (Cuenta DNI)</option>
            <option value="TJ" {% if tipo_pago == 'TJ' %}selected{% endif %}>Tarjeta</option>
            <option value="TR" {% if tipo_pago == 'TR' %}selected{% endif %}>Transferencia</option>
        </select>        
    </div>
    <div class="mb-4">
        <label for="tipo_comprobante" class="block text-gray-700 font-bold mb-2">Tipo de Comprobante:</label>
        <select name="tipo_comprobante" id="tipo_comprobante" class="w-full border border-gray-300 rounded px-3 py-2">
            <option value="ticket" {% if tipo_comprobante|stringformat:"s" == "ticket" %}selected{% endif %}>
                Consumidor Final (Ticket)
            </option>
            <option value="factura_afip" {% if tipo_comprobante|stringformat:"s" == "factura_afip" %}selected{% endif %}>
                Factura AFIP
            </option>
        </select>
    </div>


    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
            <label for="codigo" class="block text-sm font-medium text-gray-700">C贸digo:</label>
            <input type="text" name="codigo" id="codigo" required autofocus
                class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">                
        </div>

        <div>
            <label for="cantidad" class="block text-sm font-medium text-gray-700">Cantidad:</label>
            <input type="number" name="cantidad" id="cantidad" value="1" min="0.001" step="0.001" required
                class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
        </div>

        <div>
            <label for="precio" class="block text-sm font-medium text-gray-700">Precio unitario:</label>
            <input type="text" id="precio" readonly
                class="mt-1 w-full bg-gray-100 border border-gray-300 rounded-lg px-3 py-2">
        </div>
    </div>

    <div class="mt-4 flex justify-between items-center gap-x-4">
        <button type="submit" name="agregar" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
            Agregar al carrito
        </button>
       <button
            type="button"
            id="btn-f9"
            class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700"
            title="Abrir b煤squeda (F9)"
                    >
            Buscar Producto (F9)
        </button>
    </div>

</form>

{% if carrito %}
<h3 class="text-lg font-semibold mb-2">Carrito</h3>
<table class="w-full border border-gray-300 mb-4">
    <thead>
        <tr class="bg-gray-200 text-left">
            <th class="p-2">Producto</th>
            <th class="p-2">Cantidad</th>
            <th class="p-2">Precio Unitario</th>
            <th class="p-2">Subtotal</th>
            <th class="p-2">Acci贸n</th>
        </tr>
    </thead>
    <tbody>
        {% for item in carrito %}
        <tr class="border-t border-gray-300">
            <td class="p-2">{{ item.nombre }}</td>
            <td class="p-2">{{ item.cantidad }}</td>
            <td class="p-2">{{ item.precio_unitario|floatformat:0|formato_precio }}</td>
            <td class="p-2">{{ item.subtotal|floatformat:0|formato_precio }}
                {% if item.descuento > 0 %}
                <br>
                <small class="text-blue-600">
                    Descuento aplicado: -{{ item.descuento|floatformat:0 }}%
                </small>
                     {% endif %}
            </td>
            <td class="p-2">
                <form method="post" style="display:inline;">
                    {% csrf_token %}
                    <input type="hidden" name="eliminar_codigo" value="{{ item.producto_id }}">
                    <button type="submit" class="text-red-600 hover:underline">Quitar</button>
                </form>
            </td>
        </tr>
        {% endfor %}

        <script>
            // Guardar scroll antes de recargar la p谩gina (por ejemplo, al enviar un form)
            document.querySelectorAll('form').forEach(form => {
              form.addEventListener('submit', () => {
                localStorage.setItem('scrollY', window.scrollY);
              });
            });
          
            // Restaurar scroll si hay uno guardado
            window.addEventListener('load', () => {
              const scrollY = localStorage.getItem('scrollY');
              if (scrollY !== null) {
                window.scrollTo(0, parseInt(scrollY));
                localStorage.removeItem('scrollY');
              }
            });
          </script>
          
    </tbody>
    <!-- Detalles de Descuentos -->
<div id="detalles-descuentos" class="mt-4 p-4 bg-yellow-50 border border-yellow-300 rounded hidden">
    <h2 class="text-lg font-semibold mb-2 text-yellow-800">Descuentos Aplicados</h2>
    <ul id="lista-descuentos" class="list-disc list-inside text-yellow-800 text-sm"></ul>
</div>

</table>

<div class="text-right text-lg font-bold mt-2">
    <p>Total: ${{ total|floatformat:0|formato_precio }}</p>
</div>

<form method="post" id="form-finalizar">
    {% csrf_token %}
    <input type="hidden" name="tipo_comprobante" value="{{ tipo_comprobante }}">
    <input type="hidden" name="cliente" value="{{ cliente_id|default_if_none:'' }}">
    <input type="hidden" name="tipo_pago" value="{{ tipo_pago }}">

    <div class="mb-4">
        <label for="cuenta_corriente" class="inline-flex items-center">
            <input type="checkbox" name="cuenta_corriente" id="cuenta_corriente" class="form-checkbox text-blue-600" 
            
                {% if cuenta_corriente %}checked{% endif %} {% if not cliente_id %}disabled{% endif %}>
            <span id="texto-cuenta-corriente"
                class="ml-2 font-semibold {% if not cliente_id %}text-gray-400{% else %}text-gray-700{% endif %}">
                Cuenta Corriente
            </span>
        </label>
    </div>
    <div class="mb-2" x-data="{
        open: false,
        entregado: '',
        vuelto: 0,
        total: {{ total|floatformat:0 }},
        mostrarInfo: false,
        aceptar() {
            const monto = parseFloat(this.entregado);
            if (isNaN(monto) || monto < this.total) {
                alert('Ingrese un monto v谩lido que sea mayor o igual al total.');
                return;
            }
            this.vuelto = monto - this.total;
            this.open = false;
            this.mostrarInfo = true;
        },
        cerrarModal() {
        this.open = false;
     }
    }"
    @keydown.window.escape="cerrarModal()" 
    @keydown.window.prevent.f2=
    "open = true;
    $nextTick(() => $refs.inputEntregado.focus());">
        <!-- Bot贸n invisible para que el usuario sepa -->
        <button type="button" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700" @click="
        open = true;
        $nextTick(() => $refs.inputEntregado.focus());
    ">Ingresar Dinero (F2)</button>
    
        <!-- Modal -->
        <div x-show="open" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-4 rounded shadow w-96">
                <h2 class="text-lg font-bold mb-4">Dinero Entregado</h2>
                <label class="block mb-2">Cliente entrega:</label>
                <input
                x-ref="inputEntregado"
                type="number"
                x-model="entregado"
                step="0.01"
                class="w-full border px-2 py-1 mb-4"
                @keydown.enter.prevent="aceptar()" 
                @input="vuelto = parseFloat(entregado || 0) - total"
                @input="vuelto = parseFloat(entregado || 0) - total" />
                <div class="mb-4">
                    <strong>Total: </strong> $<span x-text="total.toFixed(0)"></span><br>
                    <strong>Vuelto: </strong> $<span x-text="vuelto.toFixed(0)"></span>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" @click="open = false" class="bg-gray-300 px-3 py-1 rounded">Cancelar</button>
                    <button type="button" @click="aceptar()" class="bg-green-500 text-white px-3 py-1 rounded">Aceptar</button>
                </div>
            </div>
        </div>
    
        <!-- Mostrar info debajo del bot贸n Finalizar Venta -->
        <template x-if="mostrarInfo">
            <div class="mt-4 p-3 rounded-lg border border-green-300 bg-green-50 text-green-800 text-sm shadow-sm">
                <div class="flex justify-between">
                    <span class="font-semibold">Entrega:</span>
                    <span>$<span x-text="parseFloat(entregado).toFixed(0)"></span></span>
                </div>
                <div class="flex justify-between mt-1">
                    <span class="font-semibold">Vuelto:</span>
                    <span>$<span x-text="vuelto.toFixed(0)"></span></span>
                </div>
            </div>
            
        </template>
    </div>
    <div x-data>
        <button 
        x-ref="btnFinalizar"
        type="submit" 
        name="finalizar" 
        class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700"
        @keydown.window.prevent.f4="$refs.btnFinalizar.click()">
            Finalizar Venta (F4)
        </button>
    </div>
</form>


{% endif %}

<!-- Modal de error -->
<div id="modal-error" style="display:none;"
    class="fixed inset-0 flex items-center justify-center z-50 bg-gray-500 bg-opacity-50">
    <div class="bg-white p-6 rounded-lg shadow-md w-1/3">
        <h3 class="text-lg font-semibold">Error</h3>
        <p id="modal-error-message" class="text-red-600"></p>
        <button onclick="document.getElementById('modal-error').style.display='none'"
            class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
            Cerrar
        </button>
    </div>
</div>

<!-- Audio para beep -->
<audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

<!-- Modal para ingreso de kilos -->
<div id="modalKilos" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
        <h2 class="text-lg font-semibold mb-4">Ingresar cantidad en kilos</h2>
        <p id="nombreProductoKilo" class="mb-2 text-gray-700"></p>
        <label for="cantidadKilos" class="block mb-2 text-sm font-medium text-gray-700">Cantidad (kg):</label>
        <input type="number" step="0.01" min="0.01" id="cantidadKilos"
            class="w-full border border-gray-300 rounded px-3 py-2 mb-4" />
        <div class="flex justify-end">
            <button onclick="cerrarModalKilos()" class="bg-gray-300 px-4 py-2 rounded mr-2">Cancelar</button>
            <button id="boton-agregar-kilos" onclick="confirmarKilos()"
                class="bg-blue-600 text-white px-4 py-2 rounded">Agregar</button>
        </div>
    </div>
</div>

<!-- Modal escanear c贸digo con F9 -->
<div id="modal-scan" style="display:none;" 
     class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-2xl shadow-2xl w-96">
        <h2 class="text-xl font-semibold mb-6 text-center text-gray-800"> Escanear C贸digo (F9)</h2>
        
        <input type="text" id="input-scan" autofocus
               class="w-full border border-gray-300 rounded-lg px-4 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500"
               placeholder="Escanea o ingresa el c贸digo" />
        
        <div id="detalle-producto" class="mb-4 hidden">
            <p class="text-gray-800 text-base mb-1">
                <span class="font-semibold text-gray-600">Producto:</span>
                <span id="producto-nombre" class="font-bold text-blue-700"></span>
            </p>
            <p class="text-gray-800 text-base mb-1">
                <span class="font-semibold text-gray-600">Precio:</span>
                <span id="producto-precio" class="text-2xl font-extrabold text-green-600"></span>
            </p>
            <p id="producto-descuento" class="text-green-500 font-medium mt-2"></p>
        </div>

        <div class="flex justify-end space-x-2 mt-4">
            <button id="btn-agregar"
                    class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition">
                Agregar (Enter)
            </button>
            <button id="btn-cancelar"
                    class="bg-gray-300 px-5 py-2 rounded-lg hover:bg-gray-400 transition">
                Cancelar (Esc)
            </button>
        </div>
    </div>
</div>





<script>
// == SCRIPT UNIFICADO PARA FUNCIONALIDADES DE VENTA == //

// Esperamos a que cargue todo el DOM



document.addEventListener('DOMContentLoaded', function () {

    // == VARIABLES GENERALES == //
    const inputCodigo = document.getElementById('codigo');
    const inputCantidad = document.getElementById('cantidad');
    const inputPrecio = document.getElementById('precio');
    const formAgregar = document.getElementById('form-agregar');
    const formFinalizar = document.getElementById('form-finalizar');
    const modalError = document.getElementById('modal-error');
    const modalErrorMessage = document.getElementById('modal-error-message');
    const beep = document.getElementById('beep');

    // Modal para productos por kilo
    const modalKilos = document.getElementById('modalKilos');
    const nombreProductoKilo = document.getElementById('nombreProductoKilo');
    const cantidadKilos = document.getElementById('cantidadKilos');
    const botonAgregarKilos = document.getElementById('boton-agregar-kilos');

    // Modal de escaneo F9
    const modalScan = document.getElementById('modal-scan');
    const inputScan = document.getElementById('input-scan');
    const detalleProducto = document.getElementById('detalle-producto');
    const productoNombre = document.getElementById('producto-nombre');
    const productoPrecio = document.getElementById('producto-precio');
    const productoDescuento = document.getElementById('producto-descuento');
    const btnAgregar = document.getElementById('btn-agregar');
    const btnCancelar = document.getElementById('btn-cancelar');

    // Cliente y saldo
    const selectCliente = document.getElementById('id_cliente');
    const checkboxCuentaCorriente = document.getElementById('cuenta_corriente');
    const textoCuentaCorriente = document.getElementById('texto-cuenta-corriente');
    const saldoDiv = document.getElementById('saldo-cliente');

    let productoActual = null;

    // == FUNCIONES GENERALES == //

    function mostrarError(mensaje) {
        modalErrorMessage.innerText = mensaje;
        modalError.style.display = 'flex';
    }

    function limpiarCampos() {
        inputCodigo.value = '';
        inputPrecio.value = '';
        inputCantidad.value = 1;
        inputCodigo.focus();
    }

    function limpiarCamposAgregar() {
        inputCodigo.value = '';
        inputCantidad.value = 1;
        inputPrecio.value = '';
    }

    // == PRODUCTO POR KILOS == //

    function mostrarModalKilos(data) {
        nombreProductoKilo.innerText = data.nombre;
        cantidadKilos.value = '';
        modalKilos.classList.remove('hidden');
        cantidadKilos.focus();
        productoActual = data;
    }

    function cerrarModalKilos() {
        modalKilos.classList.add('hidden');
        limpiarCamposAgregar();
        inputCodigo.focus();
    }

    function confirmarKilos() {
        const cantidad = parseFloat(cantidadKilos.value);
        if (!cantidad || cantidad <= 0) {
            alert("Por favor, ingresa una cantidad v谩lida en kilos.");
            return;
        }

        inputCantidad.value = cantidad.toFixed(3);
        inputPrecio.value = parseFloat(productoActual.precio_venta).toFixed(2);
        inputCodigo.value = productoActual.codigo;

        document.querySelector('button[name="agregar"]').click();
        cerrarModalKilos();
    }

    // == PRODUCTO POR CDIGO == //

    function buscarProducto(codigo) {
        fetch(`/productos/buscar-producto/?codigo=${codigo}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    mostrarError(data.error);
                    inputPrecio.value = '';
                } else {
                    inputPrecio.value = data.precio_venta;
                    if (beep) beep.play();

                    if (data.tipo_venta === 'kilo') {
                        mostrarModalKilos(data);
                    } else {
                        document.querySelector('button[name="agregar"]').click();
                    }
                }
            })
            .catch(error => {
                console.error('Error al buscar producto:', error);
            });
    }

    // == ESCANEO CON F9 == //

    function abrirModalScan() {
        modalScan.style.display = 'flex';
        detalleProducto.classList.add('hidden');
        inputScan.value = '';
        productoActual = null;
        inputScan.focus();
    }

    // Evento para bot贸n Buscar Producto (F9)
    document.getElementById('btn-f9').addEventListener('click', abrirModalScan);

    function cerrarModalScan() {
    modalScan.style.display = 'none';
    limpiarCamposAgregar();

        setTimeout(() => {
            const modalKilos = document.getElementById('modalKilos');
            // Si el modal kilos est谩 oculto, ponemos foco en input c贸digo principal
            if (modalKilos.classList.contains('hidden')) {
                document.getElementById('codigo').focus();
            }
            // Si modal kilos est谩 visible, NO hacemos nada para no interferir con su foco
        }, 100);  // 100ms deber铆a ser suficiente para que modal kilos se abra si debe hacerlo
    }



    function buscarProductoScan(codigo) {
        fetch(`/productos/buscar-producto/?codigo=${codigo}`)
            .then(res => res.json())
            .then(data => {
                if (!data.success) {
                    alert(data.message || 'Producto no encontrado.');
                    detalleProducto.classList.add('hidden');
                    productoActual = null;
                    return;
                }

                productoActual = data;
                productoNombre.textContent = data.nombre;
                productoPrecio.textContent = parseFloat(data.precio_venta).toFixed(2);
                productoDescuento.style.display = 'none';
                detalleProducto.classList.remove('hidden');
            })
            .catch(() => {
                alert('Error al buscar producto.');
                detalleProducto.classList.add('hidden');
                productoActual = null;
            });
    }

    function agregarAlCarritoDesdeScan() {
        if (!productoActual) {
            alert('No hay producto para agregar.');
            return;
        }

        if (productoActual.tipo_venta === 'kilo') {
            cerrarModalScan();
            mostrarModalKilos(productoActual);
            return;
        }

        inputCodigo.value = productoActual.codigo;
        inputCantidad.value = 1;
        inputPrecio.value = parseFloat(productoActual.precio_venta).toFixed(2);

        document.querySelector('button[name="agregar"]').click();
        cerrarModalScan();
    }

    // == CLIENTES Y SALDOS == //

    function actualizarCuentaCorriente() {
        if (selectCliente.value) {
            checkboxCuentaCorriente.disabled = false;
            textoCuentaCorriente.classList.remove('text-gray-400');
            textoCuentaCorriente.classList.add('text-gray-700');
        } else {
            checkboxCuentaCorriente.disabled = true;
            checkboxCuentaCorriente.checked = false;
            textoCuentaCorriente.classList.remove('text-gray-700');
            textoCuentaCorriente.classList.add('text-gray-400');
        }
    }

    function obtenerSaldoCliente(clienteId) {
        fetch(`/ventas/ajax/obtener_saldo/?cliente_id=${clienteId}`)
            .then(response => response.json())
            .then(data => {
                if (data.saldo !== undefined) {
                    saldoDiv.innerHTML = `<p><strong>Saldo actual del cliente:</strong> $${data.saldo.toFixed(2)}</p>`;
                } else {
                    saldoDiv.innerHTML = `<p><strong>Saldo actual del cliente:</strong> -</p>`;
                }
            })
            .catch(() => {
                saldoDiv.innerHTML = `<p><strong>Saldo actual del cliente:</strong> Error</p>`;
            });
    }

    // == EVENTOS == //

    inputCodigo.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const codigo = inputCodigo.value.trim();
            if (codigo.length >= 2) buscarProducto(codigo);
        }
    });

    formAgregar.addEventListener('submit', () => {
        setTimeout(() => limpiarCampos(), 100);
    });

    cantidadKilos.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            confirmarKilos();
        }
    });

    inputScan.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            if (!productoActual && inputScan.value.trim().length >= 2) {
                buscarProductoScan(inputScan.value.trim());
            } else {
                agregarAlCarritoDesdeScan();
            }
        } else if (e.key === 'Escape') {
            e.preventDefault();
            cerrarModalScan();
        }
    });

    btnCancelar.addEventListener('click', cerrarModalScan);
    btnAgregar.addEventListener('click', agregarAlCarritoDesdeScan);

    selectCliente.addEventListener('change', () => {
        actualizarCuentaCorriente();
        const clienteId = selectCliente.value;
        if (clienteId) obtenerSaldoCliente(clienteId);
        else saldoDiv.innerHTML = `<p><strong>Saldo actual del cliente:</strong> -</p>`;
    });

    window.addEventListener('keydown', (e) => {
        if (e.key === 'F9') {
            e.preventDefault();
            abrirModalScan();
        }
        if (e.key === 'Escape' && !modalKilos.classList.contains('hidden')) {
            e.preventDefault();
            cerrarModalKilos();
        }
    });

    // Inicializaci贸n al cargar
    inputCodigo.focus();
    actualizarCuentaCorriente();
});

</script>





{% endblock %}